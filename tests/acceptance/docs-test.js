import { module, test as qunitTest, skip as qunitSkip } from 'qunit';
import { visit, currentURL, click } from '@ember/test-helpers';
import { setupApplicationTest } from 'ember-qunit';
import config from 'dummy/config/environment';
import TablePage from 'ember-table/test-support/pages/ember-table';

let skip = (msg, ...args) =>
  qunitSkip(`Skip because ember-cli-addon-docs is not installed. ${msg}`, ...args);
let test = config.ADDON_DOCS_INSTALLED ? qunitTest : skip;

// The nav that contains buttons to show each snippet in a
// `{{docs.demo}}`. See https://github.com/ember-learn/ember-cli-addon-docs/blob/a00a28e33acea463d82c64fa0a712913d70de3f1/addon/components/docs-demo/template.hbs#L11
const DOCS_DEMO_SNIPPET_NAV_SELECTOR = '.docs-demo__snippets-nav';

module('Acceptance | docs', function(hooks) {
  setupApplicationTest(hooks);

  test('visiting / redirects to /docs', async function(assert) {
    await visit('/');

    assert.strictEqual(currentURL(), '/docs');
  });

  test('pages linked to by /docs nav all render', async function(assert) {
    await visit('/docs');

    let nav = this.element.querySelector('nav');
    assert.true(!!nav, 'nav exists');

    let links = Array.from(nav.querySelectorAll('a')).filter(link =>
      link.getAttribute('href').startsWith('/docs')
    );
    assert.true(links.length > 0, `${links.length} nav links found`);
    for (let link of links) {
      let href = link.getAttribute('href');
      await visit(href);
      assert.true(true, `Visited ${href} successfully`);

      let buttonCount = 0;
      let docsNavs = Array.from(this.element.querySelectorAll(DOCS_DEMO_SNIPPET_NAV_SELECTOR));
      for (let nav of docsNavs) {
        let buttons = Array.from(nav.querySelectorAll('button'));
        for (let button of buttons) {
          await click(button);
          buttonCount++;
        }
      }
      assert.true(true, `Clicked ${buttonCount} snippet buttons on "${href}"`);

      await visit('/docs'); // start over
    }
  });

  test('subcolumns docs renders cell content', async function(assert) {
    let DemoTable = TablePage.extend({
      scope: '[data-test-demo="docs-example-subcolumns"] [data-test-ember-table]',
    });

    await visit('/docs/guides/header/subcolumns');
    let table = new DemoTable();
    assert.strictEqual(
      table.header.headers.objectAt(0).text,
      'A',
      'first header cell renders correctly'
    );
    assert.strictEqual(
      table.body.rows.objectAt(0).cells.objectAt(0).text,
      'A A',
      'first body cell renders correclty'
    );
  });

  test('autogenerated API docs are present', async function(assert) {
    await visit('/docs');

    let nav = this.element.querySelector('nav');
    assert.true(!!nav, 'nav exists');

    let navItems = Array.from(nav.querySelectorAll('li'));

    let expectedNavItems = ['API REFERENCE', '<EmberTable/â€‹>'];

    expectedNavItems.forEach(expectedText => {
      assert.true(
        navItems.some(li => li.innerText.includes(expectedText)),
        `"${expectedText}" nav item is exists`
      );
    });
  });

  test('sorting: 2-state sorting works as expected', async function(assert) {
    await visit('/docs/guides/header/sorting');
    let DemoTable = TablePage.extend({
      scope: '[data-test-demo="docs-example-2-state-sortings"] [data-test-ember-table]',
    });

    let table = new DemoTable();
    let header = table.headers.objectAt(0);

    assert.false(header.sortIndicator.isPresent, 'precond - sortIndicator is not present');

    await header.click();
    assert.true(
      header.sortIndicator.isPresent && header.sortIndicator.isDescending,
      'sort descending'
    );

    await header.click();
    assert.true(
      header.sortIndicator.isPresent && header.sortIndicator.isAscending,
      'sort ascending'
    );

    await header.click();
    assert.true(
      header.sortIndicator.isPresent && header.sortIndicator.isDescending,
      'sort cycles back to descending'
    );
  });
});
